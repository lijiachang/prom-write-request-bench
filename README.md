# Prometheus Write Request Deserialization Benchmark

This repository serves as an example for pursuing better deserialization performance of the well-known 
Protobuf-encoded Prometheus [`WriteRequest`](https://github.com/prometheus/prometheus/blob/c6a42f88915b4cd3076e93a3f8c5595a4ee934f1/prompb/remote.proto#L22).

As a baseline, the deserialization implementation generated by `prost` takes about 7.3ms to decode a `WriteRequest` with 10k timeseries on our test environment.

This repository contains several branches that each did some optimization effort.

- `step1/reproduce`: reproduce the baseline
- `step2/repeated_field`: use `RepeatedField` to replace `Vec` for `repeated` field to enable pooling
- `step3/bytes`: use `bytes` to facilitate zero-copy deserialization
- `step4/bytes-eliminate-one-copy`: eliminate one `copy_to_bytes` invocation
- `step5/bench-bytes-slice`: reproduce the overhead brought by `Bytes::slice`
- `step6/optimize-slice`: hack `Bytes::slice` while ensuring lifetime guarantee

Finally, we cut the deserialization cost from 7.3ms to 1.6ms.

# 改动
在原有的代码中添加注释，方便学习

# note
* 项目使用了 Criterion 库来进行基准测试，而不是 Rust 的内置 benchmark 功能。Criterion 是一个更强大和灵活的基准测试框架。

链接：https://mp.weixin.qq.com/s/ktOGySi9HJ31G2-IOfxHZw
